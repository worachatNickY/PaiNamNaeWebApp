datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  PASSENGER
  DRIVER
  ADMIN
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RouteStatus {
  AVAILABLE
  FULL
  COMPLETED
  CANCELLED
  IN_TRANSIT
}

enum BookingStatus {
  PENDING
  CONFIRMED
  REJECTED
  CANCELLED
}

enum CancelReason {
  CHANGE_OF_PLAN               // เปลี่ยนแผน/มีธุระกะทันหัน
  FOUND_ALTERNATIVE            // พบวิธีเดินทางอื่นแล้ว
  DRIVER_DELAY                 // คนขับล่าช้าหรือเลื่อนเวลา
  PRICE_ISSUE                  // ราคาหรือค่าใช้จ่ายไม่เหมาะสม
  WRONG_LOCATION               // เลือกจุดรับ–ส่งผิด
  DUPLICATE_OR_WRONG_DATE      // จองซ้ำหรือจองผิดวัน
  SAFETY_CONCERN               // กังวลด้านความปลอดภัย
  WEATHER_OR_FORCE_MAJEURE     // สภาพอากาศ/เหตุสุดวิสัย
  COMMUNICATION_ISSUE          // สื่อสารไม่สะดวก/ติดต่อไม่ได้
}

enum LicenseType {
  PRIVATE_CAR_TEMPORARY // รถยนต์ส่วนบุคคลชั่วคราว (2 ปี)
  PRIVATE_CAR          // รถยนต์ส่วนบุคคล (5 ปี)
  PUBLIC_CAR           // รถยนต์สาธารณะ
  LIFETIME             // ตลอดชีพ
}

enum NotificationType {
  SYSTEM
  VERIFICATION
  BOOKING
  ROUTE
}

// ==================== PBI #16: Account Removal ====================
enum UserStatus {
  ACTIVE
  PENDING_DELETION
  DELETED
}

enum DeletionRequestStatus {
  PENDING
  VERIFIED
  COMPLETED
  CANCELLED
}

enum DeleteReason {
  NOT_USING_ANYMORE       // ไม่ได้ใช้งานแล้ว
  PRIVACY_CONCERN         // กังวลเรื่องความเป็นส่วนตัว
  FOUND_ALTERNATIVE       // ใช้แอปอื่นแทน
  BAD_EXPERIENCE          // ประสบการณ์ไม่ดี
  TOO_MANY_NOTIFICATIONS  // แจ้งเตือนเยอะเกินไป
  OTHER                   // เหตุผลอื่น
}

model User {
  id                    String   @id @default(cuid())
  username              String   @unique
  email                 String   @unique
  password              String
  firstName             String?
  lastName              String?
  gender                String?
  phoneNumber           String?
  profilePicture        String?
  nationalIdNumber      String?  @unique
  nationalIdPhotoUrl    String?  @unique
  nationalIdExpiryDate  DateTime?
  selfiePhotoUrl        String?
  role                  Role     @default(PASSENGER)
  isVerified            Boolean  @default(false)
  isActive              Boolean  @default(true)
  otpCode               String?
  lastLogin             DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  passengerSuspendedUntil DateTime?
  driverSuspendedUntil    DateTime?
  
  // PBI #16: Account Removal fields
  status                UserStatus @default(ACTIVE)
  deletedAt             DateTime?
  scheduledDeleteAt     DateTime?
  deleteReason          DeleteReason?
  
  driverVerification    DriverVerification?
  vehicles              Vehicle[]
  notification          Notification[]
  createdRoutes         Route[]             @relation("DriverRoutes")
  bookings              Booking[]           @relation("PassengerBookings")
  deletionRequests      DeletionRequest[]
  
  // PBI #8: Emergency Assistance
  emergencyRequests     EmergencyRequest[]  @relation("DriverEmergencies")
  emergencyContacts     EmergencyContact[]  @relation("UserEmergencyContacts")
  
  // PBI #13: Driver Reports
  reportsMade           DriverReport[]      @relation("PassengerReports")
  reportsReceived       DriverReport[]      @relation("DriverReports")

  @@index([role])
  @@index([isActive])
  @@index([isVerified])
  @@index([createdAt])
  @@index([status])
  @@index([scheduledDeleteAt])
}

model DriverVerification {
  id                  String             @id @default(cuid())
  userId              String             @unique
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  licenseNumber       String             @unique
  firstNameOnLicense  String
  lastNameOnLicense   String
  licenseIssueDate    DateTime
  licenseExpiryDate   DateTime
  licensePhotoUrl     String
  selfiePhotoUrl      String
  typeOnLicense       LicenseType
  status              VerificationStatus @default(PENDING)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([licenseIssueDate])
  @@index([licenseExpiryDate])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType @default(SYSTEM)
  title     String
  body      String
  link      String?
  metadata  Json?            @db.Json

  readAt    DateTime?
  createdAt DateTime         @default(now())
  adminReviewedAt DateTime?

  @@index([userId, createdAt])
  @@index([userId, readAt])
  @@index([adminReviewedAt])
}

model Vehicle {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicleModel  String
  licensePlate  String   @unique
  vehicleType   String
  color         String
  seatCapacity  Int
  amenities     String[]
  photos        Json?    @db.Json
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  routes        Route[]

  @@index([userId])
  @@index([createdAt])
  @@index([vehicleType])
  @@index([seatCapacity])
}

model Route {
  id              String      @id @default(cuid())
  driverId        String
  driver          User        @relation("DriverRoutes", fields: [driverId], references: [id], onDelete: Cascade)
  vehicleId       String
  vehicle         Vehicle     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  startLocation   Json        @db.Json
  endLocation     Json        @db.Json
  departureTime   DateTime
  availableSeats  Int
  pricePerSeat    Float
  conditions      String?
  status          RouteStatus @default(AVAILABLE)
  cancelledAt     DateTime?
  cancelledBy     String?     // 'DRIVER' | 'ADMIN'
  routePolyline String?
  distanceMeters Int?
  durationSeconds Int?
  routeSummary    String?
  distance        String?
  duration        String?
  waypoints       Json?        @db.Json
  landmarks       Json?       @db.Json
  steps           Json?       @db.Json
  createdAt       DateTime    @default(now())
  updatedAt     DateTime @updatedAt

  bookings        Booking[]

  @@index([driverId])
  @@index([vehicleId])
  @@index([status])
  @@index([createdAt])
  @@index([departureTime])
}

model Booking {
  id              String        @id @default(cuid())
  routeId         String
  route           Route         @relation(fields: [routeId], references: [id], onDelete: Cascade)
  passengerId     String
  passenger       User          @relation("PassengerBookings", fields: [passengerId], references: [id], onDelete: Cascade)
  numberOfSeats   Int
  status          BookingStatus @default(PENDING)
  cancelledAt     DateTime?
  cancelledBy     String?       // 'PASSENGER' | 'DRIVER' | 'ADMIN'
  cancelReason    CancelReason?
  pickupLocation  Json          @db.Json
  dropoffLocation Json          @db.Json
  createdAt       DateTime      @default(now())
  
  // PBI #13: Driver Reports
  reports         DriverReport[]
}

// ==================== PBI #16: Deletion Request ====================
model DeletionRequest {
  id            String                @id @default(cuid())
  userId        String
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reason        DeleteReason?
  otherReason   String?               // ถ้าเลือก OTHER ให้กรอกเหตุผลเพิ่ม
  otpCode       String?
  otpRef        String?
  otpExpiresAt  DateTime?
  otpAttempts   Int                   @default(0)
  status        DeletionRequestStatus @default(PENDING)
  requestedAt   DateTime              @default(now())
  verifiedAt    DateTime?
  completedAt   DateTime?
  cancelledAt   DateTime?

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
}

// ==================== Activity Log (พ.ร.บ.คอมพิวเตอร์ฯ มาตรา 26 - เก็บ 90 วัน) ====================
enum ActivityType {
  LOGIN
  LOGOUT
  REGISTER
  PASSWORD_CHANGE
  PROFILE_UPDATE
  BOOKING_CREATE
  BOOKING_CANCEL
  ROUTE_CREATE
  ROUTE_CANCEL
  PAYMENT
  ACCOUNT_DELETE_REQUEST
  ACCOUNT_DELETE_CONFIRM
  ACCOUNT_DELETE_CANCEL
  DRIVER_VERIFICATION
  EMERGENCY_REQUEST
  REPORT_SUBMIT
}

model ActivityLog {
  id            String       @id @default(cuid())
  
  // User reference (nullable เพราะ user อาจถูกลบแล้ว)
  userId        String?
  userEmail     String?      // เก็บ email ไว้เผื่อ user ถูกลบ
  
  // Activity info
  activityType  ActivityType
  description   String?
  metadata      Json?        @db.Json
  
  // Connection info (ตาม พ.ร.บ.คอมพิวเตอร์ฯ)
  ipAddress     String?
  userAgent     String?
  deviceInfo    String?
  
  // Timestamps
  createdAt     DateTime     @default(now())
  
  // สำหรับ scheduled deletion (90 วันหลังจาก user ถูกลบ)
  scheduledLogDeleteAt DateTime?

  @@index([userId])
  @@index([userEmail])
  @@index([activityType])
  @@index([createdAt])
  @@index([scheduledLogDeleteAt])
}

// ==================== PBI #8: Driver Emergency Assistance (SOS) ====================
enum EmergencyType {
  ACCIDENT          // อุบัติเหตุ
  MEDICAL           // เจ็บป่วย
  THREAT            // ถูกคุกคาม
  VEHICLE_BREAKDOWN // รถเสีย
  OTHER             // อื่นๆ
}

enum EmergencyStatus {
  ACTIVE            // กำลังดำเนินการ
  RESPONDING        // มีคนตอบรับแล้ว
  RESOLVED          // แก้ไขแล้ว
  CANCELLED         // ยกเลิก (กดผิด)
}

model EmergencyRequest {
  id            String          @id @default(cuid())
  
  // Driver info
  driverId      String
  driver        User            @relation("DriverEmergencies", fields: [driverId], references: [id], onDelete: Cascade)
  
  // Ride info (optional - ถ้ากำลังมีผู้โดยสาร)
  rideId        String?
  
  // Emergency details
  type          EmergencyType
  description   String?
  
  // Location
  latitude      Float
  longitude     Float
  address       String?
  
  // Status
  status        EmergencyStatus @default(ACTIVE)
  adminNotes    String?
  resolvedById  String?
  
  // Timestamps
  createdAt     DateTime        @default(now())
  respondedAt   DateTime?
  resolvedAt    DateTime?
  cancelledAt   DateTime?
  cancelReason  String?

  @@index([driverId])
  @@index([status])
  @@index([createdAt])
}

model EmergencyContact {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation("UserEmergencyContacts", fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  phone         String
  relationship  String?  // เช่น พ่อ, แม่, คู่สมรส, เพื่อน
  isPrimary     Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
}

// ==================== PBI #13: Passenger Report Driver Behavior ====================
enum ReportCategory {
  DRIVING_BEHAVIOR      // พฤติกรรมการขับขี่
  VEHICLE_CONDITION     // สภาพรถ
  SERVICE_QUALITY       // คุณภาพบริการ
  SAFETY_CONCERN        // ความปลอดภัย
  PAYMENT_ISSUE         // ปัญหาการเงิน
  OTHER                 // อื่นๆ
}

enum ReportType {
  // Driving Behavior
  SPEEDING              // ขับรถเร็วเกินไป
  RECKLESS_DRIVING      // ขับรถประมาท
  PHONE_WHILE_DRIVING   // ใช้โทรศัพท์ขณะขับรถ
  
  // Vehicle Condition
  DIRTY_VEHICLE         // รถไม่สะอาด
  VEHICLE_MALFUNCTION   // รถมีปัญหา/ชำรุด
  BAD_SMELL             // รถมีกลิ่นไม่พึงประสงค์
  
  // Service Quality
  RUDE_BEHAVIOR         // พูดจาไม่สุภาพ
  UNPROFESSIONAL        // ไม่เป็นมืออาชีพ
  LATE_ARRIVAL          // มาสาย
  WRONG_ROUTE           // ไม่ตามเส้นทาง
  
  // Safety Concern
  UNSAFE_FEELING        // รู้สึกไม่ปลอดภัย
  HARASSMENT            // ถูกคุกคาม
  INTOXICATED           // สงสัยว่าเมา
  
  // Payment Issue
  OVERCHARGING          // เรียกเก็บเงินเกิน
  REFUSED_PAYMENT_METHOD // ไม่รับวิธีชำระเงิน
  
  // Other
  NO_SHOW               // ไม่มารับ
  OTHER                 // อื่นๆ
}

enum ReportStatus {
  PENDING               // รอตรวจสอบ
  REVIEWING             // กำลังตรวจสอบ
  RESOLVED              // ดำเนินการแล้ว
  DISMISSED             // ยกฟ้อง (ไม่มีมูล)
}

enum ReportSeverity {
  LOW                   // เบา
  MEDIUM                // ปานกลาง
  HIGH                  // รุนแรง
  CRITICAL              // วิกฤต
}

model DriverReport {
  id              String         @id @default(cuid())
  
  // Reporter (Passenger)
  reporterId      String
  reporter        User           @relation("PassengerReports", fields: [reporterId], references: [id], onDelete: Cascade)
  
  // Reported Driver
  driverId        String
  driver          User           @relation("DriverReports", fields: [driverId], references: [id], onDelete: Cascade)
  
  // Related Booking (optional)
  bookingId       String?
  booking         Booking?       @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  
  // Report Details
  category        ReportCategory
  type            ReportType
  severity        ReportSeverity @default(MEDIUM)
  description     String
  
  // Evidence (optional)
  attachments     Json?          @db.Json  // URLs of uploaded images/videos
  
  // Status & Resolution
  status          ReportStatus   @default(PENDING)
  adminNotes      String?
  resolution      String?        // สรุปการดำเนินการ
  reviewedById    String?
  
  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  reviewedAt      DateTime?
  resolvedAt      DateTime?

  @@index([reporterId])
  @@index([driverId])
  @@index([bookingId])
  @@index([status])
  @@index([category])
  @@index([severity])
  @@index([createdAt])
}