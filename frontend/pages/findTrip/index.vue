<template>
    <div>
        <div class="px-4 py-8 mx-auto max-w-7xl sm:px-6 lg:px-8">
            <div class="p-6 mb-8 bg-white border border-gray-300 rounded-lg shadow-md">
                <h2 class="mb-6 text-xl font-semibold text-gray-900">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h2>
                <form @submit.prevent="handleSearch" class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-5">
                    <!-- ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô -->
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700">‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <div class="relative">
                            <input ref="originInputEl" v-model="searchForm.origin" type="text"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø"
                                class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î -->
                            <button type="button" @click="openPlacePicker('origin')"
                                class="absolute inset-y-0 my-auto text-gray-500 right-2 hover:text-blue-600"
                                title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
                                <!-- pin icon -->
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                    <path
                                        d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- ‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á -->
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700">‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
                        <div class="relative">
                            <input ref="destinationInputEl" v-model="searchForm.destination" type="text"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"
                                class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î -->
                            <button type="button" @click="openPlacePicker('destination')"
                                class="absolute inset-y-0 my-auto text-gray-500 right-2 hover:text-blue-600"
                                title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                    <path
                                        d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input v-model="searchForm.date" type="date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</label>
                        <select v-model="searchForm.seats"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</option>
                            <option value="1">1 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</option>
                            <option value="2">2 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</option>
                            <option value="3">3 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</option>
                            <option value="4">4 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</option>
                            <option value="5">5 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</option>
                            <!-- <option value="6">6 ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</option> -->
                        </select>
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-end gap-2">
                            <button type="submit"
                                class="w-full px-5 py-3 text-white transition duration-200 bg-blue-600 rounded-md cursor-pointer hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                            <button type="button" @click="resetSearch"
                                class="flex-1 px-5 py-3 font-medium text-gray-800 transition duration-200 bg-gray-200 rounded-md cursor-pointer hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                                ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="grid grid-cols-1 gap-6 lg:grid-cols-3 ">
                <div class="lg:col-span-2 ">
                    <div class="bg-white border border-gray-300 rounded-lg shadow-md">
                        <div class="p-6 border-b border-gray-300">
                            <h3 class="text-lg font-semibold text-gray-900">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ({{ routes.length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
                        </div>
                        <div v-if="isLoading" class="p-6 text-center text-gray-500">
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á...
                        </div>
                        <div v-else class="divide-y divide-gray-200">
                            <div v-if="routes.length === 0" class="p-6 text-center text-gray-500">
                                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </div>
                            <div v-for="route in routes" :key="route.id"
                                class="p-6 transition-all duration-300 cursor-pointer route-card hover:shadow-lg"
                                @click="toggleDetails(route)">
                                <h1 class="mb-6 font-semibold text-center text-gray-900">
                                    {{ route.originName }} <span class="mx-1 font-semibold text-gray-900">‚Üí</span> {{
                                        route.destinationName }}
                                </h1>
                                <div class="flex items-start space-x-4">
                                    <img :src="route.driver.image" :alt="route.driver.name"
                                        class="object-cover w-12 h-12 rounded-full">
                                    <div class="flex-1">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <div class="flex items-center">
                                                    <h4 class="font-semibold text-gray-900">{{ route.driver.name }}</h4>

                                                    <div v-if="route.driver.isVerified"
                                                        class="relative group ml-1.5 flex items-center">
                                                        <svg class="w-5 h-5 text-blue-600" viewBox="0 0 24 24"
                                                            fill="currentColor">
                                                            <path fill-rule="evenodd"
                                                                d="M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12c0 1.357-.6 2.573-1.549 3.397a4.49 4.49 0 01-1.307 3.498 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.49 4.49 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.07-.01l3.5-4.875z"
                                                                clip-rule="evenodd" />
                                                        </svg>
                                                        <span
                                                            class="absolute px-2 py-1 mb-2 text-xs text-white transition-opacity -translate-x-1/2 bg-gray-800 rounded-md opacity-0 pointer-events-none bottom-full left-1/2 w-max group-hover:opacity-100">
                                                            ‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="flex items-center mt-1">
                                                    <div class="flex text-yellow-400">
                                                        <span v-for="star in 5" :key="star">{{ star <=
                                                            route.driver.rating ? '‚òÖ' : '‚òÜ' }}</span>
                                                    </div>
                                                    <span class="ml-2 text-sm text-gray-600">
                                                        {{ route.driver.rating }} ({{ route.driver.reviews }} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-lg font-bold text-blue-600">{{ route.price }} ‡∏ö‡∏≤‡∏ó</div>
                                                <div class="text-sm text-gray-600">‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="flex flex-wrap items-center text-sm text-gray-600">
                                                <span class="font-medium">{{ route.date }}</span>
                                                <span class="mx-2 text-gray-300">|</span>
                                                <span class="font-medium">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å:</span>
                                                <span class="ml-1">{{ route.departureTime }}</span>
                                                <span class="mx-2 text-gray-300">|</span>
                                                <span class="font-medium">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</span>
                                                <span class="ml-1">{{ route.durationText }}</span>
                                                <span class="mx-2 text-gray-300">|</span>
                                                <span class="font-medium">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</span>
                                                <span class="ml-1">{{ route.distanceText }}</span>
                                            </div>

                                            <div class="flex items-center mt-2 text-sm text-gray-600">
                                                <span :class="[
                                                    'px-2 py-1 rounded-full text-xs font-medium',
                                                    route.availableSeats > 2 ? 'bg-green-100 text-green-800' : route.availableSeats > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'
                                                ]">
                                                    {{ route.availableSeats > 0 ? `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${route.availableSeats}
                                                    ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á` : '‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß' }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div v-if="selectedRoute && selectedRoute.id === route.id"
                                    class="pt-4 mt-4 duration-300 border-t border-gray-300 animate-in slide-in-from-top">
                                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                                        <div>
                                            <h5 class="mb-2 font-medium text-gray-900">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h5>
                                            <ul class="space-y-1 text-sm text-gray-600">
                                                <li>
                                                    ‚Ä¢ ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:
                                                    <span class="font-medium text-gray-900">{{ route.originName
                                                        }}</span>
                                                    <span v-if="route.originAddress"> ‚Äî {{ route.originAddress }}</span>
                                                </li>

                                                <template v-if="route.stops && route.stops.length">
                                                    <li class="mt-2 text-gray-700">‚Ä¢ ‡∏à‡∏∏‡∏î‡πÅ‡∏ß‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á ({{
                                                        route.stops.length }} ‡∏à‡∏∏‡∏î):</li>
                                                    <li v-for="(stop, idx) in route.stops" :key="idx">‚ÄÇ‚ÄÇ- ‡∏à‡∏∏‡∏î‡πÅ‡∏ß‡∏∞ {{ idx
                                                        + 1 }}: {{ stop }}</li>
                                                </template>

                                                <li class="mt-1">
                                                    ‚Ä¢ ‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á:
                                                    <span class="font-medium text-gray-900">{{ route.destinationName
                                                        }}</span>
                                                    <span v-if="route.destinationAddress"> ‚Äî {{ route.destinationAddress
                                                        }}</span>
                                                </li>
                                            </ul>
                                            <!-- <ul class="space-y-1 text-sm text-gray-600">
                                                <li v-for="stop in route.stops" :key="stop">‚Ä¢ {{ stop }}</li>
                                            </ul> -->
                                        </div>
                                        <div>
                                            <h5 class="mb-2 font-medium text-gray-900">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏ñ</h5>
                                            <ul class="space-y-1 text-sm text-gray-600">
                                                <li v-for="detail in route.carDetails" :key="detail">‚Ä¢ {{ detail }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="mt-4 space-y-4">
                                        <div v-if="route.conditions">
                                            <h5 class="mb-2 font-medium text-gray-900">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h5>
                                            <p
                                                class="p-3 text-sm text-gray-700 border border-gray-300 rounded-md bg-gray-50">
                                                {{ route.conditions }}
                                            </p>
                                        </div>
                                        <div v-if="route.photos && route.photos.length > 0">
                                            <h5 class="mb-2 font-medium text-gray-900">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</h5>
                                            <div class="grid grid-cols-3 gap-2 mt-2 ">
                                                <div v-for="(photo, index) in route.photos.slice(0, 3)" :key="index"
                                                    class="">
                                                    <img :src="photo" alt="Vehicle photo"
                                                        class="object-cover w-full transition-opacity border border-gray-300 rounded-lg shadow-sm cursor-pointer aspect-video hover:opacity-90">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex justify-end mt-4">
                                        <button @click.stop="openModal(route)" :disabled="route.availableSeats === 0"
                                            class="px-6 py-2 text-white transition duration-200 bg-blue-600 rounded-md cursor-pointer hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                            ‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="sticky overflow-hidden bg-white border border-gray-300 rounded-lg shadow-md top-8">
                        <div class="p-6 border-b border-gray-300">
                            <h3 class="text-lg font-semibold text-gray-900">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h3>
                        </div>
                        <div ref="mapContainer" class="h-96"></div>
                    </div>
                </div>
            </div>
        </div>

        <transition name="modal-fade">
            <div v-if="showModal && bookingRoute" class="modal-overlay" @click.self="closeModal">
                <div class="modal-content">
                    <template v-if="!bookingPickingTarget">
                        <div class="flex items-center justify-between p-6 border-b border-gray-300">
                            <h3 class="text-xl font-semibold text-gray-900">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                            <button @click="closeModal" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </template>
                    <template v-else>
                        <div class="flex items-center justify-between p-4 border-b border-gray-300">
                            <h3 class="text-lg font-semibold text-gray-900">
                                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å{{ bookingPickingTarget === 'pickup' ? '‡∏à‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ' : '‡∏à‡∏∏‡∏î‡∏•‡∏á‡∏£‡∏ñ' }}
                            </h3>
                            <button @click="stopBookingPicker" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="p-0">
                            <div ref="bookingPickerMapEl" class="w-full" style="height: 72vh;"></div>
                            <div class="flex items-center justify-between p-4 border-t border-gray-200">
                                <div class="text-sm text-gray-700 truncate">
                                    <span class="font-medium">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</span>
                                    <span class="truncate">{{ bookingPicked.name || '‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî' }}</span>
                                </div>
                                <button
                                    class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                    :disabled="!bookingPicked.name" @click="applyBookingPicked">
                                    ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ
                                </button>
                            </div>
                        </div>
                    </template>
                    <div class="p-6">
                        <div class="mb-6">
                            <h4 class="mb-3 font-semibold text-gray-900">‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏±‡∏ö</h4>
                            <div class="flex items-center p-3 space-x-3 rounded-lg bg-gray-50">
                                <img :src="bookingRoute.driver.image" :alt="bookingRoute.driver.name"
                                    class="object-cover w-12 h-12 rounded-full">
                                <div>
                                    <!-- <div class="font-medium text-gray-900">{{ bookingRoute.driver.name }}</div> -->
                                    <div class="flex items-center">
                                        <div class="font-medium text-gray-900">{{ bookingRoute.driver.name }}</div>

                                        <div v-if="bookingRoute.driver.isVerified"
                                            class="relative group ml-1.5 flex items-center">
                                            <svg class="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                                                <path fill-rule="evenodd"
                                                    d="M8.603 3.799A4.49 4.49 0 0112 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 013.498 1.307 4.491 4.491 0 011.307 3.497A4.49 4.49 0 0121.75 12c0 1.357-.6 2.573-1.549 3.397a4.49 4.49 0 01-1.307 3.498 4.491 4.491 0 01-3.497 1.307A4.49 4.49 0 0112 21.75a4.49 4.49 0 01-3.397-1.549 4.49 4.49 0 01-3.498-1.306 4.491 4.491 0 01-1.307-3.498A4.49 4.49 0 012.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 011.307-3.497 4.49 4.49 0 013.497-1.307zm7.007 6.387a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.07-.01l3.5-4.875z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                            <span
                                                class="absolute px-2 py-1 mb-2 text-xs text-white transition-opacity -translate-x-1/2 bg-gray-800 rounded-md opacity-0 pointer-events-none bottom-full left-1/2 w-max group-hover:opacity-100">
                                                ‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö‡∏Ç‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="flex text-sm text-yellow-400">
                                            <span v-for="star in 5" :key="star">{{ star <= bookingRoute.driver.rating
                                                ? '‚òÖ' : '‚òÜ' }}</span>
                                        </div>
                                        <span class="ml-2 text-sm text-gray-600">{{ bookingRoute.driver.rating }} ({{
                                            bookingRoute.driver.reviews }} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-6 mb-6 md:grid-cols-2">
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
                                <div class="p-3 text-gray-900 rounded-lg bg-gray-50">
                                    {{ bookingRoute.date }}
                                </div>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label>
                                <div class="p-3 text-gray-900 rounded-lg bg-gray-50">
                                    {{ bookingRoute.departureTime }}
                                </div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <h4 class="mb-3 font-semibold text-gray-900">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h4>
                            <div class="flex items-center p-3 space-x-4 rounded-lg bg-gray-50">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">{{ bookingRoute.originName }}</div>
                                    <div class="text-sm text-gray-600">‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>
                                </div>
                                <div class="text-blue-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7">
                                        </path>
                                    </svg>
                                </div>
                                <div class="flex-1 text-right">
                                    <div class="font-medium text-gray-900">{{ bookingRoute.destinationName }}</div>
                                    <div class="text-sm text-gray-600">‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-6 space-y-4">
                            <div>
                                <label
                                    class="block mb-2 text-sm font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</label>
                                <select v-model="bookingSeats"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option v-for="seat in bookingRoute.availableSeats" :key="seat" :value="seat">
                                        {{ seat }} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ</label>
                                <div class="relative">
                                    <input ref="pickupInputEl" v-model="pickupPoint" type="text"
                                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..."
                                        class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                                    <button type="button" @click="startBookingPicker('pickup')"
                                        class="absolute inset-y-0 my-auto text-gray-500 right-2 hover:text-blue-600"
                                        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
                                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏•‡∏á‡∏£‡∏ñ</label>
                                <div class="relative">
                                    <input ref="dropoffInputEl" v-model="dropoffPoint" type="text"
                                        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..."
                                        class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                                    <button type="button" @click="startBookingPicker('dropoff')"
                                        class="absolute inset-y-0 my-auto text-gray-500 right-2 hover:text-blue-600"
                                        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà">
                                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                            <path
                                                d="M12 2a7 7 0 00-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 mb-6 rounded-lg bg-blue-50">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-700">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</span>
                                <span class="font-medium text-gray-900">{{ bookingRoute.price }} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</span>
                                <span class="font-medium text-gray-900">{{ bookingSeats }} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</span>
                            </div>
                            <div class="pt-2 mt-2 border-t border-gray-300">
                                <div class="flex items-center justify-between">
                                    <span class="font-semibold text-gray-900">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                                    <span class="text-lg font-bold text-blue-600">{{ bookingTotalPrice }} ‡∏ö‡∏≤‡∏ó</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button @click="closeModal"
                                class="flex-1 px-4 py-3 font-semibold text-gray-800 transition duration-200 bg-gray-200 rounded-md hover:bg-gray-300">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button @click="confirmBooking"
                                class="flex-1 px-4 py-3 font-semibold text-white transition duration-200 bg-blue-600 rounded-md hover:bg-blue-700">
                                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
        <!-- Map Picker Modal -->
        <transition name="modal-fade">
            <div v-if="showPlacePicker" class="modal-overlay" @click.self="closePlacePicker">
                <div class="modal-content">
                    <div class="flex items-center justify-between p-4 border-b border-gray-300">
                        <h3 class="text-lg font-semibold text-gray-900">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å{{ pickingField === 'origin' ?
                            '‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : '‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á' }}</h3>
                        <button @click="closePlacePicker" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-4 space-y-3">
                        <div ref="placePickerMapEl" class="w-full border border-gray-200 rounded-md h-80"></div>
                        <div class="text-sm text-gray-700">
                            <div class="font-medium">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</div>
                            <div class="truncate">{{ pickedPlace.name || '‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî' }}</div>
                            <div v-if="pickedPlace.lat && pickedPlace.lng" class="text-gray-500">
                                lat: {{ pickedPlace.lat.toFixed(6) }}, lng: {{ pickedPlace.lng.toFixed(6) }}
                            </div>
                        </div>
                        <div class="flex gap-3 pt-2">
                            <button @click="closePlacePicker"
                                class="flex-1 px-4 py-2 font-semibold text-gray-800 bg-gray-200 rounded-md hover:bg-gray-300">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button :disabled="!pickedPlace.name" @click="applyPickedPlace"
                                class="flex-1 px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </div>
</template>


<script setup>
import { ref, computed, onMounted, nextTick } from 'vue'
import dayjs from 'dayjs'
import 'dayjs/locale/th'
import buddhistEra from 'dayjs/plugin/buddhistEra'
import { useToast } from '~/composables/useToast';
import { useAuth } from '~/composables/useAuth';
import { navigateTo } from '#app';

dayjs.locale('th')
dayjs.extend(buddhistEra)

const { $api } = useNuxtApp()
const { toast } = useToast();
const { token } = useAuth();
const config = useRuntimeConfig()
const GMAPS_CB = '__gmapsReady__'

// --- Booking modal: Autocomplete + Picker ---
const pickupInputEl = ref(null)
const dropoffInputEl = ref(null)
let pickupAutocomplete = null
let dropoffAutocomplete = null

// ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ API
const pickupData = ref({ lat: null, lng: null, placeId: null, address: null, name: null })
const dropoffData = ref({ lat: null, lng: null, placeId: null, address: null, name: null })

// ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏ô modal ‡πÄ‡∏î‡∏¥‡∏°
const bookingPickingTarget = ref(/** @type {'pickup'|'dropoff'|null} */(null))
const bookingPickerMapEl = ref(null)
let bookingPickerMap = null
let bookingPickerMarker = null
const bookingPicked = ref({ name: '', lat: null, lng: null, placeId: null, address: null })

// ---- NEW: refs & state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Autocomplete ----
const originInputEl = ref(null)
const destinationInputEl = ref(null)
let originAutocomplete = null
let destinationAutocomplete = null

// --- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Map Picker ---
const showPlacePicker = ref(false)
const pickingField = ref(/** @type {'origin'|'destination'|null} */(null))
const placePickerMapEl = ref(null)
let placePickerMap = null
let placePickerMarker = null
const pickedPlace = ref({ name: '', lat: null, lng: null })

const headScripts = []
if (process.client && !window.google?.maps) {
    headScripts.push({
        key: 'gmaps',                        // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Nuxt dedupe
        src: `https://maps.googleapis.com/maps/api/js?key=${config.public.googleMapsApiKey}&libraries=places,geometry&callback=${GMAPS_CB}`,
        async: true,
        defer: true
    })
}

useHead({
    title: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á - Car Pool',
    link: [
        { rel: 'stylesheet', href: 'https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap' },
        // { rel: 'stylesheet', href: 'https://unpkg.com/leaflet@1.7.1/dist/leaflet.css' }
    ],
    script: headScripts
})

const searchForm = ref({
    origin: '',
    destination: '',
    date: '',
    seats: ''
})
const RADIUS_METERS = 10000 // 10 ‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô

const routes = ref([])
const selectedRoute = ref(null)
const isLoading = ref(false)

const mapContainer = ref(null)
let gmap = null               // ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á Google
let activePolyline = null     // ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
let startMarker = null
let endMarker = null
let geocoder = null
let placesService = null
const mapReady = ref(false)
let stopMarkers = []

const showModal = ref(false)
const bookingRoute = ref(null)
const bookingSeats = ref(1)
const pickupPoint = ref('')
const dropoffPoint = ref('')

const bookingTotalPrice = computed(() => {
    if (!bookingRoute.value) return 0
    return bookingSeats.value * bookingRoute.value.price
})

function cleanAddr(a) {
    return (a || '')
        .replace(/,?\s*(Thailand|‡πÑ‡∏ó‡∏¢|‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)\s*$/i, '') // ‡∏ï‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á Thailand/‡πÑ‡∏ó‡∏¢/‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏ï‡∏£‡∏¥‡∏á
        .replace(/\s{2,}/g, ' ')                         // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ã‡πâ‡∏≥
        .trim();
}

async function ensureLatLng(field /* 'origin' | 'destination' */) {
    const metaKey = field === 'origin' ? '_originMeta' : '_destinationMeta'
    const meta = searchForm.value[metaKey]
    if (meta?.lat && meta?.lng) return { lat: meta.lat, lng: meta.lng }

    const text = searchForm.value[field]
    if (!text) return { lat: null, lng: null }

    const g = await geocodeText(text) // ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå
    if (g?.lat && g?.lng) {
        searchForm.value[metaKey] = {
            ...(meta || {}),
            lat: g.lat,
            lng: g.lng,
            placeId: g.placeId || null,
            fullAddress: g.address || null
        }
        return { lat: g.lat, lng: g.lng }
    }
    return { lat: null, lng: null }
}

async function handleSearch() {
    isLoading.value = true
    selectedRoute.value = null

    try {
        const q = { page: 1, limit: 20 }

        // --- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (optional) ---
        if (searchForm.value.date) {
            const d = dayjs(searchForm.value.date)
            q.dateFrom = d.startOf('day').toISOString()
            q.dateTo = d.endOf('day').toISOString()
        }
        if (searchForm.value.seats) {
            q.seatsRequired = Number(searchForm.value.seats)
        }
        // --- ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô / ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡πÉ‡∏™‡πà‡∏ó‡∏µ‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡πÑ‡∏î‡πâ) ---
        let usedRadius = false

        // origin (‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏ß‡πâ)
        if (searchForm.value.origin || searchForm.value._originMeta?.lat) {
            const { lat: startLat, lng: startLng } = await ensureLatLng('origin')
            if (startLat != null && startLng != null) {
                q.startNearLat = startLat
                q.startNearLng = startLng
                usedRadius = true
            }
        }

        // destination (‡∏ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏ß‡πâ)
        if (searchForm.value.destination || searchForm.value._destinationMeta?.lat) {
            const { lat: endLat, lng: endLng } = await ensureLatLng('destination')
            if (endLat != null && endLng != null) {
                q.endNearLat = endLat
                q.endNearLng = endLng
                usedRadius = true
            }
        }

        // ‡πÉ‡∏ä‡πâ radiusMeters ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ù‡∏±‡πà‡∏á
        if (usedRadius) q.radiusMeters = RADIUS_METERS

        // üîé ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å /routes ‡∏õ‡∏Å‡∏ï‡∏¥ (q ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà page/limit)
        const apiRes = await $api('/routes', { query: q })

        const raw = (apiRes?.data || apiRes || []).filter(r => r.status === 'AVAILABLE')

        // ----- ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° (map ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) -----
        routes.value = raw.map(route => {
            const wp = route.waypoints || {}
            const baseList = (Array.isArray(wp.used) && wp.used.length ? wp.used
                : Array.isArray(wp.requested) ? wp.requested : [])
            const orderedList = (Array.isArray(wp.optimizedOrder) && wp.optimizedOrder.length === baseList.length)
                ? wp.optimizedOrder.map(i => baseList[i]) : baseList

            const stops = orderedList.map(p => {
                const name = p?.name || ''
                const address = cleanAddr(p?.address || '')
                const fallback = (p?.lat != null && p?.lng != null) ? `(${p.lat.toFixed(6)}, ${p.lng.toFixed(6)})` : ''
                const title = name || fallback
                return address ? `${title} ‚Äî ${address}` : title
            }).filter(Boolean)

            const stopsCoords = orderedList
                .map(p => (p && typeof p.lat === 'number' && typeof p.lng === 'number')
                    ? { lat: p.lat, lng: p.lng, name: p.name || '', address: p.address || '' }
                    : null
                ).filter(Boolean)

            return {
                id: route.id,
                availableSeats: route.availableSeats,
                price: route.pricePerSeat,
                departureTime: dayjs(route.departureTime).format('HH:mm ‡∏ô.'),
                date: dayjs(route.departureTime).format('D MMMM BBBB'),
                start: route.startLocation,
                end: route.endLocation,
                originName: route.startLocation?.name || `(${route.startLocation.lat.toFixed(2)}, ${route.startLocation.lng.toFixed(2)})`,
                destinationName: route.endLocation?.name || `(${route.endLocation.lat.toFixed(2)}, ${route.endLocation.lng.toFixed(2)})`,
                originAddress: route.startLocation?.address ? cleanAddr(route.startLocation.address) : null,
                destinationAddress: route.endLocation?.address ? cleanAddr(route.endLocation.address) : null,
                driver: {
                    name: `${route.driver?.firstName || ''} ${route.driver?.lastName || ''}`.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
                    image: route.driver?.profilePicture || `https://ui-avatars.com/api/?name=${encodeURIComponent(route.driver?.firstName || 'U')}&background=random&size=64`,
                    rating: 4.5,
                    reviews: Math.floor(Math.random() * 50) + 5,
                    isVerified: !!route.driver?.isVerified
                },
                carDetails: route.vehicle
                    ? [`${route.vehicle.vehicleModel} (${route.vehicle.vehicleType})`, ...(route.vehicle.amenities || [])]
                    : ['‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ'],
                conditions: route.conditions,
                photos: route.vehicle?.photos || [],
                durationText: formatDuration(route.duration) || route.duration || '-',
                distanceText: formatDistance(route.distance) || route.distance || '-',
                polyline: route.routePolyline || null,
                stops,
                stopsCoords,
            }
        })

        await waitMapReady()
        const jobs = routes.value.map(async (r, i) => {
            const [o, d] = await Promise.all([
                reverseGeocode(r.start.lat, r.start.lng),
                reverseGeocode(r.end.lat, r.end.lng)
            ])
            const oParts = await extractNameParts(o)
            const dParts = await extractNameParts(d)
            if (!r.start?.name && oParts.name) routes.value[i].originName = oParts.name
            if (!r.end?.name && dParts.name) routes.value[i].destinationName = dParts.name
        })
        await Promise.allSettled(jobs)

    } catch (e) {
        console.error('Failed to fetch routes:', e)
        routes.value = []
    } finally {
        isLoading.value = false
    }
}


function reverseGeocode(lat, lng) {
    return new Promise((resolve) => {
        if (!geocoder) return resolve(null)
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
            if (status !== 'OK' || !results?.length) return resolve(null)
            resolve(results[0]) // << ‡∏Ñ‡∏∑‡∏ô object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ formatShortAddress ‡πÉ‡∏ä‡πâ address_components ‡πÑ‡∏î‡πâ
        })
    })
}

async function extractNameParts(geocodeResult) {
    if (!geocodeResult) return { name: null, area: null }

    const comps = geocodeResult.address_components || []
    const byType = (t) => comps.find(c => c.types.includes(t))?.long_name
    const byTypeShort = (t) => comps.find(c => c.types.includes(t))?.short_name

    const types = geocodeResult.types || []
    const isPoi = types.includes('point_of_interest') || types.includes('establishment') || types.includes('premise')

    // ---- ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å (name) ----
    let name = null
    if (isPoi && geocodeResult.place_id) {
        const poiName = await getPlaceName(geocodeResult.place_id)
        if (poiName) name = poiName
    }
    if (!name) {
        // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà POI -> ‡πÉ‡∏ä‡πâ‡∏ñ‡∏ô‡∏ô/‡∏ã‡∏≠‡∏¢ (route) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà + ‡∏ñ‡∏ô‡∏ô
        const streetNumber = byType('street_number')
        const route = byType('route')
        name = (streetNumber && route) ? `${streetNumber} ${route}` : (route || geocodeResult.formatted_address || null)
    }

    // ---- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (area) -> ‡∏ï‡∏≥‡∏ö‡∏•/‡∏¢‡πà‡∏≤‡∏ô + ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ----
    const sublocality =
        byType('sublocality') ||
        byType('neighborhood') ||
        byType('locality') ||
        byType('administrative_area_level_2')

    const province = byType('administrative_area_level_1') || byTypeShort('administrative_area_level_1')
    let area = null
    if (sublocality && province) area = `${sublocality}, ${province}`
    else if (province) area = province

    // ‡∏ï‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ó‡∏¥‡πâ‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏ú‡∏•‡∏≠‡∏´‡∏•‡∏∏‡∏î‡∏°‡∏≤
    // if (name) name = name.replace(/,?\s*(Thailand|‡πÑ‡∏ó‡∏¢)\s*$/i, '')
    if (name) name = name.replace(/,?\s*(Thailand|‡πÑ‡∏ó‡∏¢|‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)\s*$/i, '')

    return { name, area }
}

const toggleDetails = (route) => {
    if (selectedRoute.value && selectedRoute.value.id === route.id) {
        selectedRoute.value = null
        clearMapDrawing()
    } else {
        selectedRoute.value = route
        updateMapForRoute(route)
    }
}

function waitMapReady() {
    return new Promise((resolve) => {
        if (mapReady.value) return resolve(true)
        const t = setInterval(() => {
            if (mapReady.value) {
                clearInterval(t)
                resolve(true)
            }
        }, 50)
    })
}

function formatShortAddress(geocodeResult) {
    if (!geocodeResult) return null
    // ‡∏•‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö locality / sublocality (‡∏ï‡∏≥‡∏ö‡∏•/‡πÄ‡∏Ç‡∏ï) + administrative_area_level_1 (‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î)
    const comps = geocodeResult.address_components || []
    const byType = (t) => comps.find(c => c.types.includes(t))?.long_name

    const locality =
        byType('sublocality') ||
        byType('locality') ||
        byType('administrative_area_level_2') // ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï

    const province = byType('administrative_area_level_1') // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î

    if (locality && province) return `${locality}, ${province}`
    if (province) return province
    // fallback ‡πÄ‡∏õ‡πá‡∏ô formatted_address (‡∏™‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ)
    return geocodeResult.formatted_address || null
}

function clearMapDrawing() {
    if (activePolyline) { activePolyline.setMap(null); activePolyline = null }
    if (startMarker) { startMarker.setMap(null); startMarker = null }
    if (endMarker) { endMarker.setMap(null); endMarker = null }

    if (stopMarkers.length) {
        stopMarkers.forEach(m => m.setMap(null))
        stopMarkers = []
    }
}

async function updateMapForRoute(route) {
    if (!route) return
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Map ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡πà‡πÜ
    await waitMapReady()
    if (!gmap || !(gmap instanceof google.maps.Map)) return

    clearMapDrawing()

    // ‡∏ß‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î
    startMarker = new google.maps.Marker({
        position: { lat: route.start.lat, lng: route.start.lng },
        map: gmap, label: 'A'
    })
    endMarker = new google.maps.Marker({
        position: { lat: route.end.lat, lng: route.end.lng },
        map: gmap, label: 'B'
    })

    if (Array.isArray(route.stopsCoords) && route.stopsCoords.length) {
        stopMarkers = route.stopsCoords.map((s, idx) => new google.maps.Marker({
            position: { lat: s.lat, lng: s.lng },
            map: gmap,
            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
            title: s.name || s.address || `‡∏à‡∏∏‡∏î‡πÅ‡∏ß‡∏∞ ${idx + 1}`
        }))
    }

    // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏≤‡∏Å polyline ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (route.polyline && google.maps.geometry?.encoding) {
        const path = google.maps.geometry.encoding.decodePath(route.polyline)
        activePolyline = new google.maps.Polyline({
            path, map: gmap, strokeColor: '#2563eb', strokeOpacity: 0.9, strokeWeight: 5,
        })
        const bounds = new google.maps.LatLngBounds()
        path.forEach(p => bounds.extend(p))

        if (route.stopsCoords?.length) {
            route.stopsCoords.forEach(s => bounds.extend(new google.maps.LatLng(s.lat, s.lng)))
        }

        gmap.fitBounds(bounds) // << ‡∏ï‡∏±‡∏î arg ‡∏ó‡∏µ‡πà 2 ‡∏≠‡∏≠‡∏Å ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô overload ‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
    } else {
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ polyline -> fit ‡∏à‡∏≤‡∏Å A-B + ‡∏à‡∏∏‡∏î‡πÅ‡∏ß‡∏∞
        const bounds = new google.maps.LatLngBounds()
        bounds.extend(new google.maps.LatLng(route.start.lat, route.start.lng))
        bounds.extend(new google.maps.LatLng(route.end.lat, route.end.lng))
        if (route.stopsCoords?.length) {
            route.stopsCoords.forEach(s => bounds.extend(new google.maps.LatLng(s.lat, s.lng)))
        }
        gmap.fitBounds(bounds)
    }
}

function getPlaceName(placeId) {
    return new Promise((resolve) => {
        if (!placesService || !placeId) return resolve(null)
        placesService.getDetails(
            { placeId, fields: ['name'] },
            (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && place?.name) {
                    resolve(place.name)
                } else {
                    resolve(null)
                }
            }
        )
    })
}

async function formatPrettyAddress(geocodeResult) {
    if (!geocodeResult) return null

    const comps = geocodeResult.address_components || []
    const byType = (t) => comps.find(c => c.types.includes(t))?.long_name
    const byTypeShort = (t) => comps.find(c => c.types.includes(t))?.short_name

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (POI / landmark) ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Places
    const types = geocodeResult.types || []
    const isPoi = types.includes('point_of_interest') || types.includes('establishment') || types.includes('premise')

    if (isPoi && geocodeResult.place_id) {
        const poiName = await getPlaceName(geocodeResult.place_id)
        if (poiName) {
            // ‡πÉ‡∏™‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÜ ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏£‡∏π‡πâ‡πÄ‡∏°‡∏∑‡∏≠‡∏á
            const sublocality = byType('sublocality') || byType('neighborhood') || byType('locality') || byType('administrative_area_level_2')
            const province = byType('administrative_area_level_1') || byTypeShort('administrative_area_level_1')
            if (sublocality && province) return `${poiName}, ${sublocality}, ${province}`
            if (province) return `${poiName}, ${province}`
            return poiName
        }
    }

    // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà POI: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ñ‡∏ô‡∏ô/‡∏ã‡∏≠‡∏¢ + ‡∏¢‡πà‡∏≤‡∏ô/‡∏ï‡∏≥‡∏ö‡∏• + ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    const streetNumber = byType('street_number')
    const route = byType('route') // ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏ô/‡∏ã‡∏≠‡∏¢
    const sublocality = byType('sublocality') || byType('neighborhood') || byType('locality') || byType('administrative_area_level_2')
    const province = byType('administrative_area_level_1') || byTypeShort('administrative_area_level_1')

    const street = (streetNumber && route) ? `${streetNumber} ${route}` : (route || null)

    if (street && sublocality && province) return `${street}, ${sublocality}, ${province}`
    if (street && province) return `${street}, ${province}`
    if (sublocality && province) return `${sublocality}, ${province}`

    // fallback: ‡πÉ‡∏ä‡πâ formatted_address ‡πÅ‡∏ï‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á
    const fa = geocodeResult.formatted_address || ''
    // const trimmed = fa.replace(/,?\s*(Thailand|‡πÑ‡∏ó‡∏¢)\s*$/i, '')
    const trimmed = cleanAddr(fa)
    return trimmed || null
}

function openModal(route) {
    if (!token.value) {
        return navigateTo('/login');
    }
    if (route && route.availableSeats > 0) {
        bookingRoute.value = route
        bookingSeats.value = 1
        pickupPoint.value = ''
        dropoffPoint.value = ''
        pickupData.value = { lat: null, lng: null, placeId: null, address: null, name: null }
        dropoffData.value = { lat: null, lng: null, placeId: null, address: null, name: null }
        bookingPickingTarget.value = null
        showModal.value = true

        nextTick(() => initBookingAutocomplete())
    }
}

function closeModal() {
    showModal.value = false
    setTimeout(() => {
        bookingRoute.value = null
    }, 300);
}

async function confirmBooking() {
    if (!bookingRoute.value) return;

    // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ geocode ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    if (pickupPoint.value && !pickupData.value.lat) {
        const g1 = await geocodeText(pickupPoint.value)
        if (g1) pickupData.value = g1
    }
    if (dropoffPoint.value && !dropoffData.value.lat) {
        const g2 = await geocodeText(dropoffPoint.value)
        if (g2) dropoffData.value = g2
    }

    if (!pickupData.value.lat || !dropoffData.value.lat) {
        toast.warning('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏•‡∏á‡∏£‡∏ñ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà');
        return;
    }

    const payload = {
        routeId: bookingRoute.value.id,
        numberOfSeats: bookingSeats.value,
        pickupLocation: pickupData.value,
        dropoffLocation: dropoffData.value
    };

    try {
        await $api('/bookings', { method: 'POST', body: payload });
        closeModal();
        toast.success('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏Ç‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
        setTimeout(() => navigateTo('/myTrip'), 1500);
    } catch (error) {
        console.error("Failed to create booking:", error);
        toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á', error.data?.message || '‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
    }
}

const initializeMap = () => {
    if (!mapContainer.value || gmap) return
    gmap = new google.maps.Map(mapContainer.value, {
        center: { lat: 13.7563, lng: 100.5018 },
        zoom: 6,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
    })
    geocoder = new google.maps.Geocoder()
    placesService = new google.maps.places.PlacesService(gmap) // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    mapReady.value = true
}

function initAutocomplete() {
    if (!originInputEl.value || !destinationInputEl.value) return
    if (!window.google?.maps?.places) return

    const commonOpts = {
        fields: ['place_id', 'name', 'formatted_address', 'geometry'],
        // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: componentRestrictions: { country: ['th'] },
    }

    // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    originAutocomplete = new google.maps.places.Autocomplete(originInputEl.value, {
        ...commonOpts,
        types: ['geocode', 'establishment'],
    })
    originAutocomplete.addListener('place_changed', () => {
        const p = originAutocomplete.getPlace()
        if (!p) return
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏≠‡∏á input ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ name ‡∏à‡∏∞‡πÉ‡∏ä‡πâ formatted_address)
        searchForm.value.origin = p.name || p.formatted_address || searchForm.value.origin
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡∏¥‡∏° (‡πÑ‡∏°‡πà‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ô‡∏µ‡πâ ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠)
        searchForm.value._originMeta = {
            placeId: p.place_id || null,
            fullAddress: p.formatted_address || null,
            lat: p.geometry?.location?.lat?.() ?? null,
            lng: p.geometry?.location?.lng?.() ?? null,
        }
    })

    // ‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
    destinationAutocomplete = new google.maps.places.Autocomplete(destinationInputEl.value, {
        ...commonOpts,
        types: ['geocode', 'establishment'],
    })
    destinationAutocomplete.addListener('place_changed', () => {
        const p = destinationAutocomplete.getPlace()
        if (!p) return
        searchForm.value.destination = p.name || p.formatted_address || searchForm.value.destination
        searchForm.value._destinationMeta = {
            placeId: p.place_id || null,
            fullAddress: p.formatted_address || null,
            lat: p.geometry?.location?.lat?.() ?? null,
            lng: p.geometry?.location?.lng?.() ?? null,
        }
    })
}

function openPlacePicker(field) {
    pickingField.value = field // 'origin' | 'destination'
    pickedPlace.value = { name: '', lat: null, lng: null }
    showPlacePicker.value = true

    nextTick(() => {
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô modal
        const fallbackCenter = { lat: 13.7563, lng: 100.5018 } // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ meta ‡πÄ‡∏Å‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏ã‡∏π‡∏°‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏±‡πâ‡∏ô
        const meta = field === 'origin' ? searchForm.value._originMeta : searchForm.value._destinationMeta
        const center = (meta?.lat && meta?.lng) ? { lat: meta.lat, lng: meta.lng } : fallbackCenter

        placePickerMap = new google.maps.Map(placePickerMapEl.value, {
            center, zoom: meta?.lat ? 14 : 6,
            mapTypeControl: false, streetViewControl: false, fullscreenControl: false
        })

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
        placePickerMap.addListener('click', (e) => {
            const pos = e.latLng
            setPickerMarker(pos)
            resolvePicked(pos)
        })
    })
}

function setPickerMarker(latlng) {
    if (placePickerMarker) {
        placePickerMarker.setPosition(latlng)
        return
    }
    placePickerMarker = new google.maps.Marker({
        position: latlng, map: placePickerMap, draggable: true
    })
    placePickerMarker.addListener('dragend', (e) => {
        resolvePicked(e.latLng)
    })
}

async function resolvePicked(latlng) {
    const lat = latlng.lat(), lng = latlng.lng()

    // 1) reverse geocode ‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô
    const geocodeRes = await new Promise((resolve) => {
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
            if (status === 'OK' && results?.length) resolve(results[0])
            else resolve(null)
        })
    })

    let name = ''
    if (geocodeRes) {
        const parts = await extractNameParts(geocodeRes)
        name = parts.name || '' // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡πâ‡∏ô‡∏ï‡∏≤‡∏° logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
    }

    // 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô Plus Code ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤ POI ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô
    if (!name || isPlusCode(name)) {
        const poi = await findNearestPoi(lat, lng, 120)
        if (poi?.name) {
            name = poi.name
        } else if (geocodeRes?.formatted_address) {
            // fallback ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ‡πÉ‡∏ä‡πâ formatted_address (‡∏ï‡∏±‡∏î "Thailand/‡πÑ‡∏ó‡∏¢" ‡∏≠‡∏≠‡∏Å)
            name = geocodeRes.formatted_address.replace(/,?\s*(Thailand|‡πÑ‡∏ó‡∏¢)\s*$/i, '')
        }
    }

    pickedPlace.value = { name, lat, lng }
}

function applyPickedPlace() {
    if (!pickingField.value || !pickedPlace.value.name) return
    if (pickingField.value === 'origin') {
        searchForm.value.origin = pickedPlace.value.name
        searchForm.value._originMeta = {
            placeId: null, fullAddress: null,
            lat: pickedPlace.value.lat, lng: pickedPlace.value.lng
        }
    } else if (pickingField.value === 'destination') {
        searchForm.value.destination = pickedPlace.value.name
        searchForm.value._destinationMeta = {
            placeId: null, fullAddress: null,
            lat: pickedPlace.value.lat, lng: pickedPlace.value.lng
        }
    }
    closePlacePicker()
}
function closePlacePicker() {
    showPlacePicker.value = false
    pickingField.value = null
    // cleanup marker/map reference (‡∏ï‡∏±‡∏ß DOM ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ modal ‡∏õ‡∏¥‡∏î)
    placePickerMarker = null
    placePickerMap = null
}

function isPlusCode(text) {
    if (!text) return false
    // ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "FRGG+799" ‡∏´‡∏£‡∏∑‡∏≠ "FRGG+799, Khon Kaen"
    return /^[A-Z0-9]{4,}\+[A-Z0-9]{2,}/i.test(text.trim())
}

// helper: ‡∏´‡∏≤ POI ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡πÉ‡∏ä‡πâ
function findNearestPoi(lat, lng, radius = 100) {
    return new Promise((resolve) => {
        if (!placesService) return resolve(null)
        placesService.nearbySearch(
            { location: { lat, lng }, radius }, // ‡πÉ‡∏ä‡πâ radius ‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
            (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results?.length) {
                    resolve(results[0])   // ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                } else {
                    resolve(null)
                }
            }
        )
    })
}

function initBookingAutocomplete() {
    if (!window.google?.maps?.places) return
    const opts = { fields: ['place_id', 'name', 'formatted_address', 'geometry'], types: ['geocode', 'establishment'] }

    if (pickupInputEl.value) {
        pickupAutocomplete?.unbindAll?.()
        pickupAutocomplete = new google.maps.places.Autocomplete(pickupInputEl.value, opts)
        pickupAutocomplete.addListener('place_changed', () => {
            const p = pickupAutocomplete.getPlace()
            if (!p) return
            pickupPoint.value = p.name || p.formatted_address || pickupPoint.value
            pickupData.value = {
                lat: p.geometry?.location?.lat?.() ?? null,
                lng: p.geometry?.location?.lng?.() ?? null,
                placeId: p.place_id || null,
                address: p.formatted_address || null,
                name: p.name || null
            }
        })
    }

    if (dropoffInputEl.value) {
        dropoffAutocomplete?.unbindAll?.()
        dropoffAutocomplete = new google.maps.places.Autocomplete(dropoffInputEl.value, opts)
        dropoffAutocomplete.addListener('place_changed', () => {
            const p = dropoffAutocomplete.getPlace()
            if (!p) return
            dropoffPoint.value = p.name || p.formatted_address || dropoffPoint.value
            dropoffData.value = {
                lat: p.geometry?.location?.lat?.() ?? null,
                lng: p.geometry?.location?.lng?.() ?? null,
                placeId: p.place_id || null,
                address: p.formatted_address || null,
                name: p.name || null
            }
        })
    }
}

function startBookingPicker(target) {
    bookingPickingTarget.value = target // 'pickup' | 'dropoff'
    bookingPicked.value = { name: '', lat: null, lng: null, placeId: null, address: null }

    nextTick(() => {
        const fallbackCenter = { lat: 13.7563, lng: 100.5018 }
        const base = target === 'pickup' ? pickupData.value : dropoffData.value
        const center = (base.lat && base.lng) ? { lat: base.lat, lng: base.lng } : fallbackCenter

        bookingPickerMap = new google.maps.Map(bookingPickerMapEl.value, {
            center, zoom: base.lat ? 15 : 6,
            mapTypeControl: false, streetViewControl: false, fullscreenControl: false
        })

        bookingPickerMap.addListener('click', async (e) => {
            const pos = e.latLng
            setBookingPickerMarker(pos)
            await resolveBookingPicked(pos)
        })
    })
}
function stopBookingPicker() {
    bookingPickingTarget.value = null
    bookingPickerMap = null
    bookingPickerMarker = null
}
function setBookingPickerMarker(latlng) {
    if (bookingPickerMarker) return bookingPickerMarker.setPosition(latlng)
    bookingPickerMarker = new google.maps.Marker({ position: latlng, map: bookingPickerMap, draggable: true })
    bookingPickerMarker.addListener('dragend', (e) => resolveBookingPicked(e.latLng))
}
async function resolveBookingPicked(latlng) {
    const lat = latlng.lat(), lng = latlng.lng()
    const geocodeRes = await new Promise((resolve) => {
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
            if (status === 'OK' && results?.length) resolve(results[0]); else resolve(null)
        })
    })

    let name = '', placeId = geocodeRes?.place_id || null, address = geocodeRes?.formatted_address || null
    if (geocodeRes) {
        const parts = await extractNameParts(geocodeRes)
        name = parts.name || ''
    }

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ß‡∏¢ ‡πÜ ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á POI ‡πÉ‡∏Å‡∏•‡πâ ‡πÜ ‡∏°‡∏≤‡πÉ‡∏ä‡πâ
    if (!name) {
        const poi = await findNearestPoi(lat, lng, 120)
        if (poi?.place_id) {
            placeId = poi.place_id
            const details = await new Promise((resolve) => {
                placesService.getDetails({ placeId: poi.place_id, fields: ['name', 'formatted_address'] },
                    (pl, status) => resolve(status === google.maps.places.PlacesServiceStatus.OK ? pl : null))
            })
            name = details?.name || poi.name || name
            address = details?.formatted_address || address
        }
    }
    // if (address) address = address.replace(/,?\s*(Thailand|‡πÑ‡∏ó‡∏¢)\s*$/i, '')
    if (address) address = cleanAddr(address)

    bookingPicked.value = { name, lat, lng, placeId, address }
}
function applyBookingPicked() {
    if (!bookingPickingTarget.value || !bookingPicked.value.name) return
    const data = {
        lat: bookingPicked.value.lat,
        lng: bookingPicked.value.lng,
        placeId: bookingPicked.value.placeId,
        address: bookingPicked.value.address,
        name: bookingPicked.value.name
    }
    if (bookingPickingTarget.value === 'pickup') {
        pickupPoint.value = data.name || data.address || ''
        pickupData.value = data
    } else {
        dropoffPoint.value = data.name || data.address || ''
        dropoffData.value = data
    }
    stopBookingPicker()
}

function geocodeText(text) {
    return new Promise((resolve) => {
        if (!text) return resolve(null)
        geocoder.geocode({ address: text }, async (results, status) => {
            if (status !== 'OK' || !results?.length) return resolve(null)
            const r = results[0]
            const lat = r.geometry?.location?.lat?.()
            const lng = r.geometry?.location?.lng?.()
            const parts = await extractNameParts(r)
            resolve({
                lat, lng,
                placeId: r.place_id || null,
                // address: (r.formatted_address || '').replace(/,?\s*(Thailand|‡πÑ‡∏ó‡∏¢)\s*$/i, ''),
                address: cleanAddr(r.formatted_address || ''),
                name: parts.name || null
            })
        })
    })
}

function resetSearch() {
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    searchForm.value.origin = ''
    searchForm.value.destination = ''
    searchForm.value.date = ''
    searchForm.value.seats = ''
    // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏à‡∏≤‡∏Å autocomplete / picker
    delete searchForm.value._originMeta
    delete searchForm.value._destinationMeta

    selectedRoute.value = null
    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (API ‡∏õ‡∏Å‡∏ï‡∏¥)
    handleSearch()
}

function formatDistance(input) {
    if (typeof input !== 'string') return input
    const parts = input.split('+')
    if (parts.length <= 1) return input

    let meters = 0
    for (const seg of parts) {
        const n = parseFloat(seg.replace(/[^\d.]/g, ''))
        if (Number.isNaN(n)) continue
        if (/‡∏Å‡∏°/.test(seg)) meters += n * 1000
        else if (/‡πÄ‡∏°‡∏ï‡∏£|‡∏°\./.test(seg)) meters += n
        else meters += n // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏ï‡∏£‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢
    }

    if (meters >= 1000) {
        const km = Math.round((meters / 1000) * 10) / 10 // ‡∏õ‡∏±‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        return `${(km % 1 === 0 ? km.toFixed(0) : km)} ‡∏Å‡∏°.`
    }
    return `${Math.round(meters)} ‡∏°.`
}

function formatDuration(input) {
    if (typeof input !== 'string') return input
    const parts = input.split('+')
    if (parts.length <= 1) return input

    let minutes = 0
    for (const seg of parts) {
        const n = parseFloat(seg.replace(/[^\d.]/g, ''))
        if (Number.isNaN(n)) continue
        if (/‡∏ä‡∏°/.test(seg)) minutes += n * 60
        else minutes += n // ‡∏ô‡∏≤‡∏ó‡∏µ
    }

    const h = Math.floor(minutes / 60)
    const m = Math.round(minutes % 60)
    return h ? (m ? `${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ` : `${h} ‡∏ä‡∏°.`) : `${m} ‡∏ô‡∏≤‡∏ó‡∏µ`
}

onMounted(() => {
    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    if (window.google?.maps) {
        initializeMap()
        initAutocomplete()
        handleSearch()
        return
    }

    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à: ‡∏£‡∏≠ callback ‡∏à‡∏≤‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå
    window[GMAPS_CB] = () => {
        try {
            delete window[GMAPS_CB]
        } catch { }
        initializeMap()
        initAutocomplete()
        handleSearch()
    }
})
</script>

<style scoped>
body,
* {
    font-family: 'Kanit', sans-serif;
}

.route-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

@keyframes slide-in-from-top {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-in {
    animation-fill-mode: both;
}

.slide-in-from-top {
    animation-name: slide-in-from-top;
}

.duration-300 {
    animation-duration: 300ms;
}

.modal-overlay {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 0.75rem;
    max-width: 600px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
}

.modal-fade-enter-active,
.modal-fade-leave-active {
    transition: opacity 0.3s cubic-bezier(0.52, 0.02, 0.19, 1.02);
}

.modal-fade-enter-active .modal-content,
.modal-fade-leave-active .modal-content {
    transition: all 0.3s cubic-bezier(0.52, 0.02, 0.19, 1.02);
}

.modal-fade-enter-from,
.modal-fade-leave-to {
    opacity: 0;
}

.modal-fade-enter-from .modal-content,
.modal-fade-leave-to .modal-content {
    transform: scale(0.9) translateY(1rem);
}
</style>